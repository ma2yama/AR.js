!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("aframe"),require("three")):"function"==typeof define&&define.amd?define(["aframe","three"],e):"object"==typeof exports?exports.ARjs=e(require("aframe"),require("three")):t.ARjs=e(t.AFRAME,t.THREE)}(this,((t,e)=>(()=>{var i={254:function(t,e,i){var n;n=t=>(()=>{"use strict";var e={49:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.DeviceOrientationControls=void 0;const n=i(381),o=new n.Vector3(0,0,1),s=new n.Euler,r=new n.Quaternion,a=new n.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),c={type:"change"},d=2*Math.PI,l=.5*Math.PI;class h extends n.EventDispatcher{object;enabled;screenOrientation;alphaOffset;deviceOrientation;lastOrientation;orientationChangeEventName;smoothingFactor;connect;disconnect;update;dispose;_orderAngle;_getSmoothedAngle;constructor(t){super(),window.isSecureContext||console.error("THREE.DeviceOrientationControls: DeviceOrientationEvent is only available in secure contexts (https)");const e=this,i=new n.Quaternion;this.object=t,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.screenOrientation=0,this.alphaOffset=0,this.orientationChangeEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation",this.smoothingFactor=1;const h=function(t){e.deviceOrientation={alpha:t.alpha,beta:t.beta,gamma:t.gamma}},u=function(){e.screenOrientation=window.orientation||0};this.connect=function(){u(),"function"==typeof window.DeviceOrientationEvent.requestPermission?window.DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t&&(window.addEventListener("orientationchange",u),window.addEventListener(e.orientationChangeEventName,h))})).catch((function(t){console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)})):(window.addEventListener("orientationchange",u),window.addEventListener(e.orientationChangeEventName,h)),e.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",u),window.removeEventListener(e.orientationChangeEventName,h),e.enabled=!1},this.update=function(){if(!e.enabled)return;const t=e.deviceOrientation;if(t){let d=t.alpha?n.MathUtils.degToRad(t.alpha)+e.alphaOffset:0,h=t.beta?n.MathUtils.degToRad(t.beta):0,u=t.gamma?n.MathUtils.degToRad(t.gamma):0;const p=e.screenOrientation?n.MathUtils.degToRad(e.screenOrientation):0;if(this.smoothingFactor<1){if(null!=this.lastOrientation?.alpha&&null!=this.lastOrientation?.beta&&null!=this.lastOrientation?.gamma){const t=this.smoothingFactor;d=this._getSmoothedAngle(d,this.lastOrientation.alpha,t),h=this._getSmoothedAngle(h+Math.PI,this.lastOrientation.beta,t),u=this._getSmoothedAngle(u+l,this.lastOrientation.gamma,t,Math.PI)}else h+=Math.PI,u+=l;this.lastOrientation={alpha:d,beta:h,gamma:u}}!function(t,e,i,n,c){s.set(i,e,-n,"YXZ"),t.setFromEuler(s),t.multiply(a),t.multiply(r.setFromAxisAngle(o,-c))}(e.object.quaternion,d,this.smoothingFactor<1?h-Math.PI:h,this.smoothingFactor<1?u-l:u,p),8*(1-i.dot(e.object.quaternion))>1e-6&&(i.copy(e.object.quaternion),e.dispatchEvent(c))}},this._orderAngle=function(t,e,i=d){return e>t&&Math.abs(e-t)<i/2||t>e&&Math.abs(e-t)>i/2?{left:t,right:e}:{left:e,right:t}},this._getSmoothedAngle=function(t,e,i,n=d){const o=this._orderAngle(t,e,n),s=o.left,r=o.right;o.left=0,o.right-=s,o.right<0&&(o.right+=n);let a=r==e?(1-i)*o.right+i*o.left:i*o.right+(1-i)*o.left;return a+=s,a>=n&&(a-=n),a},this.dispose=function(){e.disconnect()},this.connect()}}e.DeviceOrientationControls=h},70:function(t,e,i){var n,o=this&&this.__createBinding||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var o=Object.getOwnPropertyDescriptor(e,i);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,n,o)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),s=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),r=this&&this.__importStar||(n=function(t){return n=Object.getOwnPropertyNames||function(t){var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[e.length]=i);return e},n(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i=n(t),r=0;r<i.length;r++)"default"!==i[r]&&o(e,t,i[r]);return s(e,t),e});Object.defineProperty(e,"__esModule",{value:!0}),e.LocationBased=void 0;const a=r(i(381)),c=i(556);e.LocationBased=class{_scene;_camera;_proj;_eventHandlers;_lastCoords;_gpsMinDistance;_gpsMinAccuracy;_maximumAge;_watchPositionId;initialPosition;initialPositionAsOrigin;constructor(t,e,i={}){this._scene=t,this._camera=e,this._proj=new c.SphMercProjection,this._eventHandlers={},this._lastCoords=null,this._gpsMinDistance=0,this._gpsMinAccuracy=100,this._maximumAge=0,this._watchPositionId=null,this.setGpsOptions(i),this.initialPosition=null!=i.initialPosition?this._proj.project(i.initialPosition.longitude,i.initialPosition.latitude):null,this.initialPositionAsOrigin=null!=i.initialPosition||i.initialPositionAsOrigin||!1}setProjection(t){this._proj=t}setGpsOptions(t={}){void 0!==t.gpsMinDistance&&(this._gpsMinDistance=t.gpsMinDistance),void 0!==t.gpsMinAccuracy&&(this._gpsMinAccuracy=t.gpsMinAccuracy),void 0!==t.maximumAge&&(this._maximumAge=t.maximumAge)}startGps(t=0){return null===this._watchPositionId&&(this._watchPositionId=navigator.geolocation.watchPosition((t=>{this._gpsReceived(t)}),(t=>{this._eventHandlers.gpserror?this._eventHandlers.gpserror(t.code):alert(`GPS error: code ${t.code}`)}),{enableHighAccuracy:!0,maximumAge:0!=t?t:this._maximumAge}),!0)}stopGps(){return null!==this._watchPositionId&&(navigator.geolocation.clearWatch(this._watchPositionId),this._watchPositionId=null,!0)}fakeGps(t,e,i=null,n=0){null!==i&&this.setElevation(i),this._gpsReceived({coords:{longitude:t,latitude:e,accuracy:n}})}lonLatToWorldCoords(t,e){const i=this._proj.project(t,e);if(this.initialPositionAsOrigin){if(!this.initialPosition)throw"Trying to use 'initial position as origin' mode with no initial position determined";i[0]-=this.initialPosition[0],i[1]-=this.initialPosition[1]}return[i[0],-i[1]]}add(t,e,i,n){this.setWorldPosition(t,e,i,n),this._scene.add(t)}setWorldPosition(t,e,i,n){const o=this.lonLatToWorldCoords(e,i);null!=n&&(t.position.y=n),[t.position.x,t.position.z]=o}setElevation(t){this._camera.position.y=t}onGpsError(t){this._eventHandlers.gpserror=t}onGpsUpdate(t){this._eventHandlers.gpsupdate=t}setWorldOrigin(t,e){this.initialPosition=this._proj.project(t,e)}_gpsReceived(t){let e=Number.MAX_VALUE;null!=t.coords.accuracy&&t.coords.accuracy<=this._gpsMinAccuracy&&(null===this._lastCoords?this._lastCoords={latitude:t.coords.latitude,longitude:t.coords.longitude}:e=this._haversineDist(this._lastCoords,t.coords),e>=this._gpsMinDistance&&(this._lastCoords.longitude=t.coords.longitude,this._lastCoords.latitude=t.coords.latitude,this.initialPositionAsOrigin&&!this.initialPosition&&this.setWorldOrigin(t.coords.longitude,t.coords.latitude),this.setWorldPosition(this._camera,t.coords.longitude,t.coords.latitude,t.coords.altitude),this._eventHandlers.gpsupdate&&this._eventHandlers.gpsupdate(t,e)))}_haversineDist(t,e){const i=a.MathUtils.degToRad(e.longitude-t.longitude),n=a.MathUtils.degToRad(e.latitude-t.latitude),o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a.MathUtils.degToRad(t.latitude))*Math.cos(a.MathUtils.degToRad(e.latitude))*(Math.sin(i/2)*Math.sin(i/2));return 2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o))*6371e3}}},556:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SphMercProjection=void 0;const i=20037508.34;e.SphMercProjection=class{constructor(){}project(t,e){return[this.lonToSphMerc(t),this.latToSphMerc(e)]}unproject(t){return[this.sphMercToLon(t[0]),this.sphMercToLat(t[1])]}lonToSphMerc(t){return t/180*i}latToSphMerc(t){return Math.log(Math.tan((90+t)*Math.PI/360))/(Math.PI/180)*i/180}sphMercToLon(t){return t/i*180}sphMercToLat(t){let e=t/i*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),e}getID(){return"epsg:3857"}}},54:function(t,e,i){var n,o=this&&this.__createBinding||(Object.create?function(t,e,i,n){void 0===n&&(n=i);var o=Object.getOwnPropertyDescriptor(e,i);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,n,o)}:function(t,e,i,n){void 0===n&&(n=i),t[n]=e[i]}),s=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),r=this&&this.__importStar||(n=function(t){return n=Object.getOwnPropertyNames||function(t){var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[e.length]=i);return e},n(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i=n(t),r=0;r<i.length;r++)"default"!==i[r]&&o(e,t,i[r]);return s(e,t),e});Object.defineProperty(e,"__esModule",{value:!0}),e.WebcamRenderer=void 0;const a=r(i(381));e.WebcamRenderer=class{renderer;sceneWebcam;geom;texture;material;cameraWebcam;constructor(t,e){let i;this.renderer=t,this.renderer.autoClear=!1,this.sceneWebcam=new a.Scene,void 0===e?(i=document.createElement("video"),i.setAttribute("autoplay","true"),i.setAttribute("playsinline","true"),i.style.display="none",document.body.appendChild(i)):i=e,this.geom=new a.PlaneGeometry,this.texture=new a.VideoTexture(i),this.material=new a.MeshBasicMaterial({map:this.texture});const n=new a.Mesh(this.geom,this.material);if(this.sceneWebcam.add(n),this.cameraWebcam=new a.OrthographicCamera(-.5,.5,.5,-.5,0,10),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const t={video:{width:1280,height:720,facingMode:"environment"}};navigator.mediaDevices.getUserMedia(t).then((t=>{console.log("using the webcam successfully..."),i.srcObject=t,i.play()})).catch((t=>{setTimeout((()=>{this.createErrorPopup("Webcam Error\nName: "+t.name+"\nMessage: "+t.message)}),1e3)}))}else setTimeout((()=>{this.createErrorPopup("sorry - media devices API not supported")}),1e3)}update(){this.renderer.clear(),this.renderer.render(this.sceneWebcam,this.cameraWebcam),this.renderer.clearDepth()}dispose(){this.material.dispose(),this.texture.dispose(),this.geom.dispose()}createErrorPopup(t){if(!document.getElementById("error-popup")){const e=document.createElement("div");e.innerHTML=t,e.setAttribute("id","error-popup"),document.body.appendChild(e)}}}},381:e=>{e.exports=t}},i={};function n(t){var o=i[t];if(void 0!==o)return o.exports;var s=i[t]={exports:{}};return e[t].call(s.exports,s,s.exports,n),s.exports}var o={};return(()=>{var t=o;Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceOrientationControls=t.WebcamRenderer=t.LocationBased=void 0;const e=n(70);Object.defineProperty(t,"LocationBased",{enumerable:!0,get:function(){return e.LocationBased}});const i=n(54);Object.defineProperty(t,"WebcamRenderer",{enumerable:!0,get:function(){return i.WebcamRenderer}});const s=n(49);Object.defineProperty(t,"DeviceOrientationControls",{enumerable:!0,get:function(){return s.DeviceOrientationControls}})})(),o})(),t.exports=n(i(381))},223:e=>{"use strict";e.exports=t},381:t=>{"use strict";t.exports=e}},n={};function o(t){var e=n[t];if(void 0!==e)return e.exports;var s=n[t]={exports:{}};return i[t].call(s.exports,s,s.exports,o),s.exports}o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};return(()=>{"use strict";o.r(s);var t=o(223),e=o(381);t.registerComponent("arjs-webcam-texture",{init:function(){this.scene=this.el.sceneEl,this.texCamera=new e.OrthographicCamera(-.5,.5,.5,-.5,0,10),this.texScene=new e.Scene,this.scene.renderer.autoClear=!1,this.video=document.createElement("video"),this.video.setAttribute("autoplay",!0),this.video.setAttribute("playsinline",!0),this.video.setAttribute("display","none"),document.body.appendChild(this.video),this.geom=new e.PlaneBufferGeometry,this.texture=new e.VideoTexture(this.video),this.material=new e.MeshBasicMaterial({map:this.texture});const t=new e.Mesh(this.geom,this.material);this.texScene.add(t)},play:function(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const t={video:{facingMode:"environment"}};navigator.mediaDevices.getUserMedia(t).then((t=>{this.video.srcObject=t,this.video.play()})).catch((t=>{this.el.sceneEl.systems.arjs._displayErrorPopup(`Webcam error: ${t}`)}))}else this.el.sceneEl.systems.arjs._displayErrorPopup("sorry - media devices API not supported")},tick:function(){this.scene.renderer.clear(),this.scene.renderer.render(this.texScene,this.texCamera),this.scene.renderer.clearDepth()},pause:function(){this.video.srcObject.getTracks().forEach((t=>{t.stop()}))},remove:function(){this.material.dispose(),this.texture.dispose(),this.geom.dispose()}});var i=o(254);t.registerComponent("gps-new-camera",{schema:{simulateLatitude:{type:"number",default:0},simulateLongitude:{type:"number",default:0},simulateAltitude:{type:"number",default:-Number.MAX_VALUE},gpsMinDistance:{type:"number",default:0},positionMinAccuracy:{type:"number",default:100},gpsTimeInterval:{type:"number",default:0},initialPositionAsOrigin:{type:"boolean",default:!1}},init:function(){this._testForOrientationControls(),this.fakeGpsStarted=!1,this.threeLoc=new i.LocationBased(this.el.sceneEl.object3D,this.el.object3D,{initialPositionAsOrigin:this.data.initialPositionAsOrigin}),this.threeLoc.onGpsUpdate((t=>{this._currentPosition={longitude:t.coords.longitude,latitude:t.coords.latitude},this._sendGpsUpdateEvent(t.coords.longitude,t.coords.latitude)})),this.threeLoc.onGpsError((t=>{t>=1&&t<=3?this._displayError(["User denied access to GPS.","GPS satellites not available.","Timeout communicating with GPS satellites - try moving to a more open area."][t-1]):this._displayError(`Unknown geolocation error code ${t}.`)}));const t=this._isMobile();this.el.setAttribute("look-controls-enabled",!t),t&&this.el.setAttribute("arjs-device-orientation-controls",!0),navigator.userAgent.match(/Version\/[\d.]+.*Safari/)&&this._setupSafariOrientationPermissions(),this.el.sceneEl.addEventListener("gps-entity-place-added",(t=>{const e=t.detail.component.components["gps-new-entity-place"];this._currentPosition&&e.setDistanceFrom(this._currentPosition)}))},update:function(t){this.threeLoc.setGpsOptions({gpsMinAccuracy:this.data.positionMinAccuracy,gpsMinDistance:this.data.gpsMinDistance,maximumAge:this.data.gpsTimeInterval}),this.fakeGpsStarted||0===this.data.simulateLatitude&&0===this.data.simulateLongitude||this.data.simulateLatitude==t.simulateLatitude&&this.data.simulateLongitude==t.simulateLongitude||(this.threeLoc.stopGps(),this.threeLoc.fakeGps(this.data.simulateLongitude,this.data.simulateLatitude),this.fakeGpsStarted=!0),this.data.simulateAltitude>-Number.MAX_VALUE&&this.threeLoc.setElevation(this.data.simulateAltitude+1.6)},play:function(){0===this.data.simulateLatitude&&0===this.data.simulateLongitude&&this.threeLoc.startGps()},pause:function(){this.threeLoc.stopGps()},latLonToWorld:function(t,e){return this.threeLoc.lonLatToWorldCoords(e,t)},getInitialPosition:function(){return this.threeLoc.initialPosition},_sendGpsUpdateEvent:function(t,e){this.el.emit("gps-camera-update-position",{position:{longitude:t,latitude:e}})},_testForOrientationControls:function(){this.el.components["arjs-device-orientation-controls"]||this.el.components["look-controls"]||this._displayError("WARNING - No orientation controls component, app will not respond to device rotation.")},_displayError:function(t){const e=this.el.sceneEl.systems.arjs;e?e._displayErrorPopup(t):alert(t)},_setupSafariOrientationPermissions:function(){if("function"==typeof window.DeviceOrientationEvent?.requestPermission){var t=function(){console.log("Requesting device orientation permissions..."),DeviceOrientationEvent.requestPermission(),document.removeEventListener("touchend",t)};document.addEventListener("touchend",(function(){t()}),!1),this.el.sceneEl.systems.arjs._displayErrorPopup("After camera permission prompt, please tap the screen to activate geolocation.")}else{var e=setTimeout((()=>{this.el.sceneEl.systems.arjs._displayErrorPopup("Please enable device orientation in Settings > Safari > Motion & Orientation Access.")}),750);window.addEventListener("deviceorientation",(function(){clearTimeout(e)}),{once:!0})}},_isMobile:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}),t.registerComponent("gps-new-entity-place",{schema:{longitude:{type:"number",default:0},latitude:{type:"number",default:0}},init:function(){const t=document.querySelector("[gps-new-camera]");t.components["gps-new-camera"]?(this._cameraGps=t.components["gps-new-camera"],t.addEventListener("gps-camera-update-position",(t=>{this.distance=this._haversineDist(t.detail.position,this.data)})),this.el.sceneEl.emit("gps-entity-place-added",{component:this.el})):console.error("gps-new-camera not initialised")},update:function(){const t=this._cameraGps.threeLoc.lonLatToWorldCoords(this.data.longitude,this.data.latitude);this.el.object3D.position.set(t[0],this.el.object3D.position.y,t[1])},setDistanceFrom:function(t){this.distance=this._haversineDist(t,this.data)},_haversineDist:function(t,i){const n=e.MathUtils.degToRad(i.longitude-t.longitude),o=e.MathUtils.degToRad(i.latitude-t.latitude),s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e.MathUtils.degToRad(t.latitude))*Math.cos(e.MathUtils.degToRad(i.latitude))*(Math.sin(n/2)*Math.sin(n/2));return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371e3}}),t.registerComponent("arjs-device-orientation-controls",{schema:{smoothingFactor:{type:"number",default:1}},init:function(){this._orientationControls=new THREEx.DeviceOrientationControls(this.el.object3D)},update:function(){this._orientationControls.smoothingFactor=this.data.smoothingFactor},tick:function(){this._orientationControls.update()}})})(),s})()));